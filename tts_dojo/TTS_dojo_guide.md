# TTS Dojo

The TTS Dojo is a simplified workflow for changing the voice of text-to-speech models using [rhasspy/piper](https://github.com/rhasspy/piper).
## MAJOR FEATURE UPDATE MAY 24 2024:
- Full training environment with both automatic and manual checkpoint saving, voice model generation, and ability to preview and compare voices while training.
- Ability to stop and resume training from a previous checkpoint
- Interactive management of dojo files
- Automatic activation of virtual environment throughout


## Notes before we begin
1. Piper must be installed before you can use the dojo. I recommend using `install_piper.sh` to ensure everything ends up in the expected locations.
2. `tts_dojo/DOJO_CONTENTS` is the directory structure that will be cloned for each model you train.  Don't change the contents of this folder unless you know what you're wanting to accomplish.
3. Piper expects datasets that have sampling rates of either 16000Hz or 22050Hz.   Low quality pretrained piper models use 16000Hz datasets, and 22050Hz datasets are used by medium and high quality models.  TextyMcSpeechy automatically creates `wav` files at both of these sampling rates when you create your dataset by running `tts_dojo/DATASETS/create_dataset.sh`


## Gathering your training files.
You will need: 
- a dataset for your target voice consisting of a collection of audio files and a `metadata.csv` file containing the transcripts must be created in `tts_dojo/DATASETS`
- a checkpoint file `.ckpt` of a [partially trained text-to-speech model](https://huggingface.co/datasets/rhasspy/piper-checkpoints/tree/main).   Default checkpoint files should be stored in the folder structure found in `tts_dojo/PRETRAINED_CHECKPOINTS`.


## Usage
1. `cd tts_dojo`
2. your dataset must be scanned and repackaged before it can be used with the dojo.  To do this, create a folder in the `tts_dojo/DATASETS` folder, copy your audio files and metadata.csv file inside, and run `./create_dataset.sh <your_dataset_folder>` Please keep backups of your original files!
3. Default pretrained piper TTS checkpoint files for each voice type `[M/F]` and quality setting `[low, medium, high]` are to be stored in the folders found in `/tts_dojo/PRETRAINED_CHECKPOINTS`.   You will need to add these files yourself, either by manually [downloading](https://huggingface.co/datasets/rhasspy/piper-checkpoints/tree/main) them and copying them into the appropriate folders or by running `download_defaults.sh`, which currently only includes a set of links for `en-us` language checkpoints.  (Warning, running this script will download approximately 5GB of data)
4. Once your dataset is created, run `./newdojo.sh <VOICE_NAME>` to create the directory structure (inside `<VOICE_NAME>_dojo`)  for the components of your new model.  Note: newdojo.sh stores several paths in hidden files inside the dojo folder.  If you move your dojo folder to another location after creating it, the scripts will not work unless you manually update the paths in `.BIN_DIR`, `.DOJO_DIR`, and `.PIPER_PATH`.
5. `cd <VOICE_NAME>_dojo` 
6. Run `./start_training.sh` and choose your dataset from the menu.  This script will preprocess your dataset and then open the training environment.
7. Training can take a long time (hours).  If you choose to quit training, the next time you run `./start_training.sh` you will be given the option to resume where you left off.
8. The training scripts run in a multi-window environment provided by `tmux`.  The tmux session is named `training`.   This session can be shut down from any terminal window with the command `tmux kill-session` if there is a problem and the normal ways of shutting the session down are unavailable.


## What do the different windows in the training dojo do?
0. `PIPER TRAINING RAW OUTPUT`  This pane contains all of the text generated by piper as it trains your model.  For the most part you can ignore it.
   - You may see `rank_zero_warn (` appear for several minutes as training is initializing.  This is normal.
   - You may see a warning about a low number of workers being a bottleneck.  Currently the only way to resolve this is to modify piper's source code.
   - If you see an error related to `zip` files here, this usually means your starting checkpoint file is corrupted.   Either restart training or delete the highest epoch checkpoint in the `voice_checkpoints` directory.
1. `TENSORBOARD SERVER`  This pane is where the web server that lets you view graphs related to training progress runs.  Open http://localhost:6006 in your web browser if you want to see them.  When the graph for "loss_disc_all" levels off, your model is probably almost ready.
2. `TTS MODEL EXPORTER` This pane contains piper's output when it converts a checkpoint file into a `.onnx` file.  For the most part this can be ignored as well.
3. `CHECKPOINT GRABBER` This pane contains a script which allows you to periodically save one of the checkpoint files that piper generates during training and convert it into a text-to-speech model.   Saving these files periodically as the model trains allows you to decide which version of the voice sounds the best.   Please be careful with this tool as leaving it unattended and saving checkpoint files frequently could quite easily fill your entire hard drive -- each checkpoint file is over 800MB.
4. `CONTROL CONSOLE`  Currently the only control available here is to shut down the training session.   Select this pane and press `q`.
5. `VOICE TESTER` This allows you to hear what the voice associated with a saved checkpoint file sounds like.  After at least one checkpoint has been saved, a list of voice files will appear in this window.   Use the arrow keys to choose the voice you want to hear, then press `s` to have it speak the text in the `"Text to say:"` field.  Any voice that appears in the voice tester pane is ready to be used in your Piper projects.  You will find the voices in `<VOICE_NAME_dojo>/tts_voices` 





